<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini IG con Historias y Chat</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; margin: 0; padding: 0; }
    .page { display: none; padding-bottom: 60px; }
    .active { display: block; }
    nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      display: flex; justify-content: space-around;
      background: #fff; border-top: 1px solid #dbdbdb; height: 60px;
    }
    nav button {
      flex: 1; border: none; background: none; font-size: 1.2em; cursor: pointer;
    }
    .post {
      background: #fff; border-bottom: 1px solid #dbdbdb; padding: 1em;
      margin-bottom: 5px;
    }
    .stories-bar {
      display: flex; overflow-x: auto; padding: 1em; background: #fff;
      border-bottom: 1px solid #dbdbdb;
    }
    .story {
      text-align: center; margin-right: 1em; cursor: pointer;
    }
    .story img {
      width: 60px; height: 60px; border-radius: 50%;
      border: 2px solid #c13584; object-fit: cover;
    }
    .story p {
      font-size: 0.7em; margin: 0.5em 0 0 0;
    }
    .profile-header {
      display: flex; align-items: center; padding: 1em; background: #fff;
      border-bottom: 1px solid #dbdbdb;
    }
    .profile-pic {
      width: 80px; height: 80px; border-radius: 50%; background: #ddd;
      overflow: hidden; margin-right: 1em; cursor: pointer;
    }
    .profile-pic img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .profile-info { flex: 1; }
    .profile-info h2 { margin: 0 0 0.5em 0; }
    .stats {
      display: flex; gap: 1em;
    }
    .stats div {
      text-align: center;
    }
    .edit-btn {
      margin-top: 0.5em; padding: 0.4em 1em; border: 1px solid #dbdbdb;
      background: none; cursor: pointer;
    }
    .profile-bio {
      padding: 1em; background: #fff; border-bottom: 1px solid #dbdbdb;
    }
    .profile-posts {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px;
    }
    .profile-posts img, .profile-posts video {
      width: 100%; height: 100%; object-fit: cover;
    }
    .create-post-container {
      background: #fff; max-width: 500px; margin: 1em auto;
      border: 1px solid #dbdbdb; border-radius: 8px; padding: 1em;
    }
    .create-post-header {
      font-weight: bold; text-align: center; margin-bottom: 1em;
    }
    textarea {
      width: 100%; border: none; border-bottom: 1px solid #dbdbdb;
      resize: none; padding: 0.5em 0; outline: none;
    }
    .file-input-label {
      display: block; background: #0095f6; color: #fff;
      text-align: center; padding: 0.5em; margin: 1em 0;
      border-radius: 4px; cursor: pointer;
    }
    #fileInput { display: none; }
    .preview {
      margin: 1em 0; text-align: center;
    }
    .preview img, .preview video {
      max-width: 100%; border-radius: 8px;
    }
    .post-btn {
      width: 100%; background: #0095f6; color: #fff; border: none;
      padding: 0.75em; font-weight: bold; border-radius: 4px;
      cursor: pointer; font-size: 1em;
    }
    .post-btn:disabled {
      background: #b2dffc; cursor: not-allowed;
    }
    .settings {
      padding: 1em;
      max-width: 400px;
      margin: 0 auto;
      background: white;
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      margin-top: 1em;
    }
    .settings input {
      display: block; margin: 0.5em 0; padding: 0.5em;
      width: 100%; box-sizing: border-box;
      font-size: 1em;
    }
    /* Chat styles */
    #chatMessages {
      background: #fff; height: 300px; overflow-y: auto; border: 1px solid #dbdbdb;
      padding: 0.5em; margin-bottom: 0.5em; border-radius: 6px;
    }
    #chatMessages div {
      margin-bottom: 0.5em;
      padding: 0.3em 0.6em;
      border-radius: 12px;
      max-width: 75%;
      word-wrap: break-word;
    }
    .chat-msg-you {
      background: #0095f6;
      color: white;
      margin-left: auto;
    }
    .chat-msg-them {
      background: #e4e6eb;
      color: black;
      margin-right: auto;
    }
    #chatInput {
      width: 100%; padding: 0.5em; box-sizing: border-box; font-size: 1em;
      border: 1px solid #dbdbdb; border-radius: 4px;
    }
    #chatSendBtn {
      margin-top: 0.5em; background: #0095f6; color: white; border: none;
      padding: 0.75em; width: 100%; font-weight: bold; border-radius: 4px;
      cursor: pointer;
    }
    #chatUsersList {
      background: #fff; max-height: 150px; overflow-y: auto; border: 1px solid #dbdbdb;
      padding: 0.5em; margin-bottom: 0.5em; border-radius: 6px;
    }
    #chatUsersList div {
      padding: 0.5em;
      cursor: pointer;
      border-radius: 6px;
    }
    #chatUsersList div:hover {
      background: #0095f6;
      color: white;
    }
  </style>
</head>
<body>

  <!-- HOME -->
  <div id="home" class="page active">
    <div class="stories-bar" id="storiesBar"></div>
    <div id="posts"></div>
  </div>

  <!-- ACCOUNT -->
  <div id="account" class="page">
    <div class="profile-header">
      <div class="profile-pic" onclick="changeProfilePic()">
        <img id="profilePic" src="https://via.placeholder.com/80" alt="Foto de perfil">
      </div>
      <div class="profile-info">
        <h2 id="usernameDisplay">Usuario</h2>
        <div class="stats">
          <div><strong id="postCount">0</strong><br>Publicaciones</div>
          <div><strong id="followersCount">0</strong><br>Seguidores</div>
          <div><strong id="followingCount">0</strong><br>Seguidos</div>
        </div>
        <button class="edit-btn" onclick="editBio()">Editar perfil</button>
      </div>
    </div>
    <div class="profile-bio">
      <p id="bioText">Aqu√≠ va tu bio</p>
    </div>
    <div class="profile-posts" id="profilePosts"></div>
  </div>

  <!-- CREATE POST -->
  <div id="create" class="page">
    <div class="create-post-container">
      <div class="create-post-header">Crear publicaci√≥n</div>
      <textarea id="caption" rows="3" placeholder="Escribe un pie de foto..."></textarea>
      <label class="file-input-label" for="fileInput">Elegir imagen o video</label>
      <input type="file" id="fileInput" accept="image/*,video/*">
      <div class="preview" id="preview"></div>
      <button class="post-btn" id="postBtn" onclick="createPost()" disabled>Compartir</button>
    </div>
  </div>

  <!-- CHAT -->
  <div id="chat" class="page">
    <div class="settings" style="max-width:600px;">
      <h2>Chat 1 a 1</h2>
      <p><strong>Usuario actual:</strong> <span id="chatCurrentUser">Ninguno</span></p>
      <div id="chatUsersList"></div>
      <div id="chatMessages"></div>
      <textarea id="chatInput" rows="2" placeholder="Escribe un mensaje..." disabled></textarea>
      <button id="chatSendBtn" disabled>Enviar</button>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settings" class="page">
    <div class="settings">
      <h2>Configuraci√≥n</h2>
      <input type="text" id="username" placeholder="Nombre de usuario" autocomplete="username" />
      <input type="email" id="email" placeholder="Correo" autocomplete="email" />
      <input type="password" id="password" placeholder="Contrase√±a" autocomplete="current-password" />
      <button onclick="signUp()">Crear cuenta</button>
      <button onclick="signIn()">Iniciar sesi√≥n</button>
      <button onclick="signOut()">Cerrar sesi√≥n</button>
    </div>
  </div>

  <!-- NAV -->
  <nav>
    <button onclick="showPage('home')">üè†</button>
    <button onclick="showPage('account')">üë§</button>
    <button onclick="showPage('create')">‚ûï</button>
    <button onclick="showPage('chat')">üí¨</button>
    <button onclick="showPage('settings')">‚öôÔ∏è</button>
  </nav>

<script>
  let currentUser = localStorage.getItem('currentUser') || null;
  let chatTarget = null; // user to chat with

  // ----------------- NAVIGATION -----------------
  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'account') loadProfile();
    else if (id === 'home') renderPosts();
    else if (id === 'chat') {
      if (!currentUser) {
        alert('Inicia sesi√≥n para usar el chat.');
        showPage('settings');
        return;
      }
      loadChatUsers();
      loadChatMessages();
      updateChatUI();
    }
  }

  // ----------------- AUTH -----------------
  function signUp() {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value;
    const email = document.getElementById('email').value.trim();

    if (!user || !pass || !email) {
      alert('Completa todos los campos para crear cuenta.');
      return;
    }
    if(users[user]) {
      alert('El usuario ya existe.');
      return;
    }
    users[user] = {
      password: pass,
      email: email,
      followers: [],
      bio: '',
      profilePic: '',
      following: []
    };
    localStorage.setItem('users', JSON.stringify(users));
    alert('Cuenta creada, ahora inicia sesi√≥n.');
    // limpiar campos
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('email').value = '';
  }

  function signIn() {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value;

    if(!users[user] || users[user].password !== pass) {
      alert('Datos incorrectos.');
      return;
    }
    currentUser = user;
    localStorage.setItem('currentUser', currentUser);
    alert(`Sesi√≥n iniciada como ${currentUser}`);
    // limpiar campos
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('email').value = '';
    showPage('home');
  }

  function signOut() {
    if (!currentUser) {
      alert('No hay sesi√≥n iniciada.');
      return;
    }
    localStorage.removeItem('currentUser');
    currentUser = null;
    chatTarget = null;
    alert('Sesi√≥n cerrada.');
    showPage('settings');
  }

  // ----------------- POSTS -----------------
  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('preview');
  const caption = document.getElementById('caption');
  const postBtn = document.getElementById('postBtn');

  fileInput.addEventListener('change', handleFileChange);
  caption.addEventListener('input', togglePostButton);

  function handleFileChange() {
    preview.innerHTML = '';
    const file = fileInput.files[0];
    if (!file) {
      togglePostButton();
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      if (file.type.startsWith('image/')) preview.innerHTML = `<img src="${e.target.result}">`;
      else if (file.type.startsWith('video/')) preview.innerHTML = `<video src="${e.target.result}" controls></video>`;
      togglePostButton();
    };
    reader.readAsDataURL(file);
  }

  function togglePostButton() {
    postBtn.disabled = !(caption.value.trim() || fileInput.files.length > 0);
  }

  function createPost() {
    if (!currentUser) {
      alert('Inicia sesi√≥n primero.');
      return;
    }
    const posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const file = fileInput.files[0];
    let newPost = { 
      id: Date.now(),
      user: currentUser,
      text: caption.value.trim(),
      media: null,
      type: null,
      likes: [],
      comments: []
    };
    if(file){
      const reader = new FileReader();
      reader.onload = e => {
        newPost.media = e.target.result;
        newPost.type = file.type.startsWith('image/') ? 'image' : 'video';
        posts.unshift(newPost);
        localStorage.setItem('posts', JSON.stringify(posts));
        resetPostForm();
        renderPosts();
        alert('Publicaci√≥n creada!');
      };
      reader.readAsDataURL(file);
    } else {
      posts.unshift(newPost);
      localStorage.setItem('posts', JSON.stringify(posts));
      resetPostForm();
      renderPosts();
      alert('Publicaci√≥n creada!');
    }
  }

  function resetPostForm() {
    caption.value = '';
    fileInput.value = '';
    preview.innerHTML = '';
    togglePostButton();
  }

  // Render posts with likes and comments
  function renderPosts() {
    renderStories();
    const posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const postsDiv = document.getElementById('posts');
    postsDiv.innerHTML = '';

    posts.forEach(p => {
      const isLiked = currentUser && p.likes.includes(currentUser);
      let commentsHtml = '';
      p.comments.forEach(c => {
        commentsHtml += `<div><strong>${c.user}:</strong> ${escapeHTML(c.text)}</div>`;
      });
      postsDiv.innerHTML += `
        <div class="post" id="post-${p.id}">
          <strong>${p.user}</strong>
          <p>${escapeHTML(p.text)}</p>
          ${p.media && p.type==='image' ? `<img src="${p.media}" style="width:100%; border-radius:8px;">` : ''}
          ${p.media && p.type==='video' ? `<video src="${p.media}" style="width:100%; border-radius:8px;" controls muted></video>` : ''}
          <div style="margin-top:0.5em;">
            <button onclick="toggleLike(${p.id})" style="cursor:pointer;">
              ${isLiked ? '‚ù§Ô∏è Quitar like' : 'ü§ç Like'} (${p.likes.length})
            </button>
          </div>
          <div style="margin-top:0.5em;">
            <input type="text" id="commentInput-${p.id}" placeholder="Escribe un comentario..." style="width: 70%; padding:0.3em;"/>
            <button onclick="addComment(${p.id})" style="padding:0.3em 0.6em; cursor:pointer;">Enviar</button>
          </div>
          <div style="margin-top:0.5em; max-height:100px; overflow-y:auto; font-size:0.9em; background:#f0f0f0; padding:0.5em; border-radius:6px;">
            ${commentsHtml}
          </div>
        </div>
      `;
    });
  }

  // Like toggle function
  function toggleLike(postId) {
    if (!currentUser) {
      alert('Inicia sesi√≥n para dar like.');
      return;
    }
    const posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    const likeIndex = post.likes.indexOf(currentUser);
    if (likeIndex === -1) post.likes.push(currentUser);
    else post.likes.splice(likeIndex,1);
    localStorage.setItem('posts', JSON.stringify(posts));
    renderPosts();
  }

  // Add comment function// Agregar comentario a post
  function addComment(postId) {
    if (!currentUser) {
      alert('Inicia sesi√≥n para comentar.');
      return;
    }
    const input = document.getElementById(`commentInput-${postId}`);
    if (!input) return;
    const text = input.value.trim();
    if (!text) return alert('Escribe un comentario.');
    const posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    post.comments.push({ user: currentUser, text });
    localStorage.setItem('posts', JSON.stringify(posts));
    input.value = '';
    renderPosts();
  }

  // ----------------- PROFILE -----------------
  function loadProfile() {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    const posts = JSON.parse(localStorage.getItem('posts') || '[]');
    if (!currentUser || !users[currentUser]) return;
    const u = users[currentUser];
    document.getElementById('usernameDisplay').innerText = currentUser;
    document.getElementById('bioText').innerText = u.bio || 'Sin bio';
    document.getElementById('profilePic').src = u.profilePic || 'https://via.placeholder.com/80';
    document.getElementById('followersCount').innerText = u.followers ? u.followers.length : 0;
    document.getElementById('followingCount').innerText = u.following ? u.following.length : 0;
    document.getElementById('postCount').innerText = posts.filter(p => p.user === currentUser).length;

    const profilePosts = document.getElementById('profilePosts');
    profilePosts.innerHTML = '';
    posts.filter(p => p.user === currentUser).forEach(p => {
      if (p.media && p.type === 'image') profilePosts.innerHTML += `<img src="${p.media}">`;
      else if (p.media && p.type === 'video') profilePosts.innerHTML += `<video src="${p.media}" muted controls></video>`;
    });
  }

  function editBio() {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    const newBio = prompt('Nueva bio:', users[currentUser]?.bio || '');
    if (newBio !== null && currentUser) {
      users[currentUser].bio = newBio;
      localStorage.setItem('users', JSON.stringify(users));
      loadProfile();
    }
  }

  function changeProfilePic() {
    if (!currentUser) {
      alert('Inicia sesi√≥n primero.');
      return;
    }
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = () => {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          const users = JSON.parse(localStorage.getItem('users') || '{}');
          users[currentUser].profilePic = e.target.result;
          localStorage.setItem('users', JSON.stringify(users));
          loadProfile();
        };
        reader.readAsDataURL(file);
      }
    };
    input.click();
  }

  // ----------------- STORIES -----------------
  function renderStories() {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    const stories = JSON.parse(localStorage.getItem('stories') || '{}');
    const bar = document.getElementById('storiesBar');
    bar.innerHTML = '';

    Object.keys(users).forEach(user => {
      if (stories[user]) {
        bar.innerHTML += `<div class="story" onclick="viewStory('${user}')">
          <img src="${users[user].profilePic || 'https://via.placeholder.com/80'}" alt="${user}">
          <p>${user}</p>
        </div>`;
      }
    });

    if (currentUser) {
      bar.innerHTML += `<div class="story" onclick="manageMyStory()">
        <img src="${users[currentUser]?.profilePic || 'https://via.placeholder.com/80'}" alt="Tu historia">
        <p>T√∫</p>
      </div>`;
    }
  }

  function manageMyStory() {
    if (!currentUser) return alert('Inicia sesi√≥n primero.');
    const stories = JSON.parse(localStorage.getItem('stories') || '{}');
    if (stories[currentUser]) viewStory(currentUser);
    else uploadStory();
  }

  function uploadStory() {
    if (!currentUser) return alert('Inicia sesi√≥n primero.');
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,video/*';
    input.onchange = () => {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          const stories = JSON.parse(localStorage.getItem('stories') || '{}');
          stories[currentUser] = { media: e.target.result, type: file.type.startsWith('image/') ? 'image' : 'video' };
          localStorage.setItem('stories', JSON.stringify(stories));
          alert('Historia subida!');
          renderStories();
        };
        reader.readAsDataURL(file);
      }
    };
    input.click();
  }

  function viewStory(user) {
    const stories = JSON.parse(localStorage.getItem('stories') || '{}');
    const story = stories[user];
    if (!story) return alert('No hay historia.');
    const viewer = document.createElement('div');
    viewer.style.position = 'fixed';
    viewer.style.top = 0;
    viewer.style.left = 0;
    viewer.style.width = '100%';
    viewer.style.height = '100%';
    viewer.style.background = 'rgba(0,0,0,0.9)';
    viewer.style.display = 'flex';
    viewer.style.justifyContent = 'center';
    viewer.style.alignItems = 'center';
    viewer.style.zIndex = 9999;
    viewer.innerHTML = `<div style="position:relative; max-width:90%; max-height:90%;">
      ${story.type==='image'
        ? `<img src="${story.media}" style="max-width:100%; max-height:100%;">`
        : `<video src="${story.media}" controls autoplay style="max-width:100%; max-height:100%;"></video>`}
      <button onclick="this.parentElement.parentElement.remove()" style="
        position:absolute; top:10px; right:10px; background:#fff; border:none;
        font-size:1.5em; cursor:pointer; border-radius:50%;">&times;</button></div>`;
    document.body.appendChild(viewer);
  }

  // ----------------- CHAT -----------------
  function loadChatUsers() {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    const list = document.getElementById('chatUsersList');
    list.innerHTML = '';
    Object.keys(users).forEach(u => {
      if (u !== currentUser) {
        const div = document.createElement('div');
        div.textContent = u;
        div.onclick = () => {
          chatTarget = u;
          updateChatUI();
          loadChatMessages();
        };
        if (chatTarget === u) div.style.background = '#0095f6'; div.style.color = 'white';
        list.appendChild(div);
      }
    });
  }

  function updateChatUI() {
    document.getElementById('chatCurrentUser').innerText = currentUser || 'Ninguno';
    document.getElementById('chatInput').disabled = !chatTarget;
    document.getElementById('chatSendBtn').disabled = !chatTarget;
    if (!chatTarget) {
      document.getElementById('chatMessages').innerHTML = '<p>Selecciona un usuario para chatear.</p>';
    }
  }

  document.getElementById('chatSendBtn').onclick = () => {
    sendMessage();
  };
  document.getElementById('chatInput').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function sendMessage() {
    if (!currentUser || !chatTarget) {
      alert('Inicia sesi√≥n y selecciona un usuario para chatear.');
      return;
    }
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    const chats = JSON.parse(localStorage.getItem('chats') || '{}');
    // chat ID: usuario1|usuario2 ordenados alfabeticamente para que sea √∫nico
    const chatId = [currentUser, chatTarget].sort().join('|');
    if (!chats[chatId]) chats[chatId] = [];
    chats[chatId].push({ sender: currentUser, text, timestamp: Date.now() });
    localStorage.setItem('chats', JSON.stringify(chats));
    input.value = '';
    loadChatMessages();
  }

  function loadChatMessages() {
    if (!currentUser || !chatTarget) return;
    const chatId = [currentUser, chatTarget].sort().join('|');
    const chats = JSON.parse(localStorage.getItem('chats') || '{}');
    const messages = chats[chatId] || [];
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';
    messages.forEach(m => {
      const div = document.createElement('div');
      div.textContent = `${m.sender}: ${m.text}`;
      div.className = m.sender === currentUser ? 'chat-msg-you' : 'chat-msg-them';
      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
  }

  // ----------------- UTILITIES -----------------
  function escapeHTML(text) {
    const div = document.createElement('div');
    div.innerText = text;
    return div.innerHTML;
  }

  // ----------------- INIT -----------------
  // Cuando carga la p√°gina
  window.onload = () => {
    if (currentUser) {
      showPage('home');
    } else {
      showPage('settings');
    }
  };
</script>
</body>
</html>